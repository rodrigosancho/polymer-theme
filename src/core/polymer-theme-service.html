<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="polymer-theme-variable.html">

<dom-module id="polymer-theme-service">
    <template>
        <style>
            :host {
                display: none;
            }
        </style>
        
        <!-- Application Variables -->
        <polymer-theme-variable key="siteUrl" value="{{ siteUrl }}"></polymer-theme-variable>
        <polymer-theme-variable key="offline" value="{{ offline }}"></polymer-theme-variable>
        
    </template>
    <script>
        Polymer({
            is: 'polymer-theme-service',

            properties: {
                api: {
                    type: String,
                    value: '/wp-json/wp/v2/'
                },
                pageSize:{
                    type: Number,
                    value: 10,
                },
                loading: {
                    type: Boolean,
                    value: false,
                    notify: true,
                    reflectToAttribute: true
                }
            },

            _onLoading: function(loading){
                this.loading = loading;
                /*this.fire('loading', {
                    loading: loading
                })*/
            },

            _handleResponse: function(response, event){
                this.fire(event, {
                    response: response
                });

                this._onLoading(false);
            },

            _handleError: function(response){
                this.fire('error', {
                    response: response
                });

                this._onLoading(false);
            },

            _mountUrl : function(siteUrl, api, endPoint, params){
                var url = new URL(siteUrl + api + endPoint);
                //Handling params
                if(params){
                    Object.keys(params).forEach(function(key){
                        if(key === 'filters'){
                            //Handling filters
                            var filters = params[key];
                            Object.keys(filters).forEach(function(filterKey){
                                url.searchParams.append('filters['+ filterKey +']', filters[filterKey]);
                            });
                        }else{
                            url.searchParams.append(key, params[key]);
                        }
                    });
                }

                return url;
            },

            _get: function(endPoint, event, params){

                this._onLoading(true);

                var url = this._mountUrl(this.siteUrl, this.api, endPoint, params);

                //Fetching the information
                fetch(url)
                .then(function(response){
                    if(!response.ok) this._handleError(response);
                    else {
                        response.json()
                        .then(function(json){
                            this._handleResponse(json, event);
                        }.bind(this));
                    }
                }.bind(this))
                .catch(function(response){
                    this._handleError(response);
                }.bind(this))
                
            },

            getPosts: function(page){
                var params = {
                    per_page : this.pageSize,
                    page: page || 1
                };

                this._get('posts', 'posts-received', params);
            },

            getPostByID: function(id){
                this._get('posts/' + id, 'post-received');
            },

            getPostBySlug: function(slug){
                var params = {
                    slug : slug
                };

                this._get('posts', 'post-received', params);
            },

            getPages: function(){
                var params = {
                    filters : {
                        post_per_page: -1 //Return all the pages
                    }
                };

                this._get('pages', 'pages-received', params)
            },

            getPageByID: function(id){
                this._get('pages/' + id, 'page-received');
            },

            getPageBySlug: function(slug){
                var params = {
                    slug : slug
                };

                this._get('pages', 'page-received', params);
            }
        });
    </script>
</dom-module>
