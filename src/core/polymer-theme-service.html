<link rel="import" href="../../bower_components/polymer/polymer.html">
<!--<link rel="import" href="../../bower_components/global-variable/global-variable.html">-->
<link rel="import" href="../../bower_components/uniflow-polymer/state-aware.html">


<dom-module id="polymer-theme-service">
    <template>
        <style>
            :host {
                display: none;
            }
        </style>

        <!-- Application Variables -->
        <!--<global-variable key="siteUrl" value="{{ siteUrl }}"></global-variable>-->
        <!--<global-variable key="offline" value="{{ offline }}"></global-variable>-->

    </template>
    <script>
        Polymer({
            is: 'polymer-theme-service',

            properties: {
                api: {
                    type: String,
                    value: '/wp-json/wp/v2/'
                },
                pageSize: {
                    type: Number,
                    value: 10
                },
                loading: {
                    type: Boolean,
                    value: false,
                    notify: true,
                    reflectToAttribute: true
                }
            },

            behaviors: [
                UniFlow.StateAware
            ],

            ready: function(){
                console.log("hola");
            },

            attached: function(){
                console.log("hola");
                console.log(this.state);
            },

            _onLoading: function (loading) {
                this.loading = loading;
                /*this.fire('loading', {
                 loading: loading
                 })*/
            },

            _handleResponse: function (response, event) {
                this.fire(event, {
                    response: response
                });

                this._onLoading(false);
            },

            _handleError: function (response) {
                this.fire('error', {
                    response: response
                });

                this._onLoading(false);
            },

            _mountUrl: function (siteUrl, api, endPoint, params) {
                var url = new URL(siteUrl + api + endPoint);
                //Handling params
                if (params) {
                    Object.keys(params).forEach(function (key) {
                        if (key === 'filters') {
                            //Handling filters
                            var filters = params[key];
                            Object.keys(filters).forEach(function (filterKey) {
                                url.searchParams.append('filters[' + filterKey + ']', filters[filterKey]);
                            });
                        } else {
                            url.searchParams.append(key, params[key]);
                        }
                    });
                }

                return url;
            },

            getRequest: function (endPoint, event, params) {

                this._onLoading(true);

                var url = this._mountUrl(this.state.siteUrl, this.api, endPoint, params);

                //Fetching the information
                fetch(url)
                        .then(function (response) {
                            if (!response.ok) this._handleError(response);
                            else {
                                response.json()
                                        .then(function (json) {
                                            this._handleResponse(json, event);
                                        }.bind(this));
                            }
                        }.bind(this))
                        .catch(function (response) {
                            this._handleError(response);
                        }.bind(this))

            },

            getPosts: function (page) {
                var params = {
                    per_page: this.pageSize,
                    page: page || 1
                };

                this.getRequest('posts', 'posts-received', params);
            },

            getPostByID: function (id) {
                this.getRequest('posts/' + id, 'post-received');
            },

            getPostBySlug: function (slug) {
                var params = {
                    slug: slug
                };

                this.getRequest('posts', 'post-received', params);
            },

            getPages: function () {
                var params = {
                    filters: {
                        post_per_page: -1 //Return all the pages
                    }
                };

                this.getRequest('pages', 'pages-received', params)
            },

            getPageByID: function (id) {
                this.getRequest('pages/' + id, 'page-received');
            },

            getPageBySlug: function (slug) {
                var params = {
                    slug: slug
                };

                this.getRequest('pages', 'page-received', params);
            }
        });
    </script>
</dom-module>
